server {
  listen 8080;
  add_header X-Frame-Options "DENY";
  add_header X-Content-Type-Options "nosniff";
  add_header Content-Security-Policy   "connect-src 'self' ${VITE_BACKEND_API_URL} ${VITE_SEGMENT_API_URL};
                                        frame-src 'self' *.youtube.com *.wikipedia.org ${AUT0_DOMAIN};
                                        script-src 'self' 'unsafe-inline' https://accounts.google.com/gsi/client;
                                        default-src 'self' *.${VITE_FRONTEND_HOSTNAME} data:;
                                        style-src 'self' *.googleapis.com 'unsafe-inline';" always ;
  gzip on;
  
  # Never cache index.html - MUST come before default location
  location = /index.html {
    root /usr/share/nginx/html;
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
  }

  # Cache static assets with hash in filename for long time (8+ hex chars before extension)
  location ~* ^/assets/.*\.[a-f0-9]{8,}.*\.(js|css|png|jpg|jpeg|gif|svg|woff|woff2|ico)$ {
    root /usr/share/nginx/html;
    expires 1y;
    add_header Cache-Control "public, immutable" always;
    try_files $uri =404;
  }

  # Favicons and other static files
  location ~* ^/(favicons?|robots\.txt|sitemap\.xml) {
    root /usr/share/nginx/html;
    expires 7d;
    add_header Cache-Control "public" always;
    try_files $uri =404;
  }

  # Default location - SPA fallback for all other routes
  location / {
    root /usr/share/nginx/html;
    index index.html index.htm;
    try_files $uri $uri/ /index.html;
    # Don't cache the fallback to index.html for SPA routes
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
  }   

  location /public {
    root /usr/local/var/www;
  }
}
